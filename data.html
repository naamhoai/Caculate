<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Hóa Đơn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body class="container">
    <h2 class="text-center mt-4">Danh Sách Hóa Đơn</h2>
    <ul id="invoiceList" class="list-group"></ul>
    <div class="text-center mt-3">
        <!-- Sửa dòng 18 từ: -->
        <a href="index.html" class="btn btn-secondary">Quay lại nhập đơn hàng</a>
        <!-- Giữ nguyên vì đã đúng -->
    </div>

    <div id="editSection" class="mt-4" style="display:none;">
        <h3>Chỉnh sửa hóa đơn</h3>
        <ul id="editInvoiceList" class="list-group"></ul>

        <div class="row mt-3">
            <div class="col-md-4">
                <select id="productCategory" class="form-select" onchange="updateProductOptions()">
                    <option value="">Chọn loại sản phẩm</option>
                    <option value="foods">Đồ ăn</option>
                    <option value="drinks">Đồ uống</option>
                    <option value="tabaco">Thuốc lá</option>
                </select>
            </div>
            <div class="col-md-4">
                <select id="newProduct" class="form-select" disabled>
                    <option value="">Chọn sản phẩm</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="number" id="newQuantity" class="form-control" placeholder="Số lượng" min="1" value="1">
            </div>
        </div>

        <div class="mt-3">
            <button class="btn btn-success" onclick="addProduct()">Thêm sản phẩm</button>
            <button class="btn btn-primary" onclick="saveEdits()">Lưu chỉnh sửa</button>
            <button class="btn btn-secondary" onclick="cancelEdit()">Hủy</button>
        </div>
    </div>

    <script>
        const products = {
            foods: [
                { id: 1, name: "Khoai tây chiên", price: 30000, type: "food" },
                { id: 2, name: "Nem chua rán", price: 35000, type: "food" },
                { id: 3, name: "Cá bống", price: 40000, type: "food" },
                { id: 4, name: "Cá mực", price: 45000, type: "food" },
                { id: 5, name: "Cá chỉ vàng", price: 40000, type: "food" },
                { id: 6, name: "Xúc xích", price: 20000, type: "food" },
                { id: 7, name: "Lạp xưởng", price: 25000, type: "food" },
                { id: 8, name: "Hoa quả", price: 30000, type: "food" },
                { id: 9, name: "Thịt xiên nướng", price: 15000, type: "food" },
                { id: 10, name: "Viên chả cá", price: 20000, type: "food" }
            ],
            drinks: [
                { id: 11, name: "Trà chanh", price: 15000, type: "drink" },
                { id: 12, name: "Trà đào", price: 20000, type: "drink" },
                { id: 13, name: "Trà quất", price: 20000, type: "drink" },
                { id: 14, name: "Nước mía", price: 10000, type: "drink" },
                { id: 15, name: "Sting", price: 15000, type: "drink" },
                { id: 16, name: "Bò húc", price: 15000, type: "drink" },
                { id: 17, name: "Bia", price: 25000, type: "drink" },
                { id: 18, name: "Coca chai to bán theo cốc nhỏ", price: 10000, type: "drink" }
            ],
            tabaco: [
                { id: 19, name: "Thăng long", price: 50000, type: "tabaco" },
                { id: 20, name: "Sài gòn xanh", price: 60000, type: "tabaco" }
            ]
        };

        // Cập nhật danh sách sản phẩm khi chọn loại
        function updateProductOptions() {
            const category = document.getElementById('productCategory').value;
            const productSelect = document.getElementById('newProduct');

            productSelect.innerHTML = '<option value="">Chọn sản phẩm</option>';
            productSelect.disabled = !category;

            if (category) {
                products[category].forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} - ${product.price.toLocaleString()}đ`;
                    productSelect.appendChild(option);
                });
            }
        }

        // Thêm sản phẩm vào hóa đơn đang chỉnh sửa
        function addProduct() {
            const productId = parseInt(document.getElementById('newProduct').value);
            const quantity = parseInt(document.getElementById('newQuantity').value);

            if (!productId || !quantity) {
                alert('Vui lòng chọn sản phẩm và nhập số lượng');
                return;
            }

            // Tìm sản phẩm trong tất cả các loại
            let selectedProduct = null;
            for (const category in products) {
                const found = products[category].find(p => p.id === productId);
                if (found) {
                    selectedProduct = found;
                    break;
                }
            }

            if (selectedProduct) {
                // Thêm vào danh sách chỉnh sửa (cần triển khai logic tùy vào hệ thống của bạn)
                console.log('Thêm sản phẩm:', selectedProduct.name, 'Số lượng:', quantity);
                // TODO: Thêm vào editInvoiceList
            }
        }

        // Lưu chỉnh sửa
        function saveEdits() {
            // TODO: Triển khai logic lưu chỉnh sửa
            alert('Đã lưu chỉnh sửa');
            document.getElementById('editSection').style.display = 'none';
        }

        // Hủy chỉnh sửa
        function cancelEdit() {
            document.getElementById('editSection').style.display = 'none';
        }
    </script>

    <script>
        let editingIndex = null;

        function loadInvoices() {
            let invoices = JSON.parse(localStorage.getItem("invoices")) || [];
            let invoiceList = document.getElementById("invoiceList");
            invoiceList.innerHTML = "";

            if (invoices.length === 0) {
                invoiceList.innerHTML = `
                    <li class="list-group-item text-center text-muted py-4">
                        <img src="empty-box.png" alt="Empty" style="height: 60px; opacity: 0.6;" class="mb-2">
                        <div>Chưa có hóa đơn nào</div>
                    </li>
                `;
                return;
            }

            invoices.forEach((inv, index) => {
                let totalAmount = inv.invoice.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let paymentMethod = inv.payment || "Chưa thanh toán";

                let statusClass = paymentMethod === "Chưa thanh toán" ? "bg-secondary" :
                    paymentMethod === "Tiền mặt" ? "bg-warning text-dark" : "bg-success";

                let li = document.createElement("li");
                li.className = "list-group-item";
                li.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div>
                            <h5 class="mb-1">Hóa đơn #${index + 1}</h5>
                            <small class="text-muted">${inv.date}</small>
                        </div>
                        <span class="badge ${statusClass}">${paymentMethod}</span>
                    </div>
                    
                    <ul class="list-group list-group-flush my-2">
                        ${inv.invoice.map(item => `
                            <li class="list-group-item d-flex justify-content-between py-1">
                                <span>${item.product} x ${item.quantity}</span>
                                <span>${(item.price * item.quantity).toLocaleString()} VND</span>
                            </li>
                        `).join("")}
                    </ul>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="text-danger">${totalAmount.toLocaleString()} VND</strong>
                        <div>
                            <button class="btn btn-sm btn-outline-info" onclick="viewInvoiceDetails(${index})">
                                Chi tiết
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editInvoice(${index})">
                                Sửa
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteInvoice(${index})">
                                Xóa
                            </button>
                            ${paymentMethod === "Chưa thanh toán" ? `
                                <button class="btn btn-sm btn-warning ms-1" onclick="payCash(${index})">
                                    Tiền mặt
                                </button>
                                <button class="btn btn-sm btn-primary ms-1" onclick="payTransfer(${index})">
                                    Chuyển khoản
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                invoiceList.appendChild(li);
            });
        }

        function payCash(index) {
            let invoices = JSON.parse(localStorage.getItem("invoices")) || [];
            invoices[index].payment = "Tiền mặt";
            localStorage.setItem("invoices", JSON.stringify(invoices));
            loadInvoices();
        }

        function payTransfer(index) {
            let invoices = JSON.parse(localStorage.getItem("invoices")) || [];
            invoices[index].payment = "Chuyển khoản";
            localStorage.setItem("invoices", JSON.stringify(invoices));
            window.location.href = `qr.html?index=${index}`;
        }

        function editInvoice(index) {
            editingIndex = index;
            let invoices = JSON.parse(localStorage.getItem("invoices")) || [];
            let invoice = invoices[index].invoice;
            document.getElementById("editSection").style.display = "block";
            let editInvoiceList = document.getElementById("editInvoiceList");
            editInvoiceList.innerHTML = "";
            invoice.forEach((item, i) => {
                let li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `
                    <div>
                        <strong>${item.product}</strong>
                        <div class="text-muted small">${item.price.toLocaleString()} VND x ${item.quantity}</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeProduct(${i})">
                        Xóa
                    </button>
                `;
                editInvoiceList.appendChild(li);
            });
        }

        function removeProduct(productIndex) {
            let invoices = JSON.parse(localStorage.getItem("invoices"));
            invoices[editingIndex].invoice.splice(productIndex, 1);
            localStorage.setItem("invoices", JSON.stringify(invoices));
            editInvoice(editingIndex);
        }

        function addProduct() {
            let newProduct = document.getElementById("newProduct").value;
            let newQuantity = parseInt(document.getElementById("newQuantity").value, 10);
            let invoices = JSON.parse(localStorage.getItem("invoices"));

            if (!newProduct || !newQuantity || newQuantity < 1) {
                alert("Vui lòng chọn sản phẩm và nhập số lượng hợp lệ!");
                return;
            }

            let invoice = invoices[editingIndex].invoice;
            let existingProduct = invoice.find(item => item.product === newProduct);

            if (existingProduct) {
                existingProduct.quantity += newQuantity;
            } else {
                let defaultPrice =
                    newProduct === "Sản phẩm A" ? 100000 :
                        newProduct === "Sản phẩm B" ? 200000 : 300000;

                invoice.push({
                    product: newProduct,
                    price: defaultPrice,
                    quantity: newQuantity
                });
            }

            localStorage.setItem("invoices", JSON.stringify(invoices));
            document.getElementById("newProduct").value = "";
            document.getElementById("newQuantity").value = "";
            editInvoice(editingIndex);
        }

        function saveEdits() {
            document.getElementById("editSection").style.display = "none";
            loadInvoices();
        }

        function deleteInvoice(index) {
            if (confirm("Bạn có chắc chắn muốn xóa hóa đơn này?")) {
                let invoices = JSON.parse(localStorage.getItem("invoices")) || [];
                invoices.splice(index, 1);
                localStorage.setItem("invoices", JSON.stringify(invoices));
                loadInvoices();
            }
        }

        // Cập nhật hàm viewInvoiceDetails trong data.html
        function viewInvoiceDetails(index) {
            let invoices = JSON.parse(localStorage.getItem("invoices")) || [];
            if (invoices.length > index) {
                let invoice = invoices[index].invoice;
                let total = invoice.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let paymentMethod = invoices[index].payment || "Chưa thanh toán";

                let details = `
            <div class="p-3">
                <h4>HÓA ĐƠN #${index + 1}</h4>
                <p><strong>Ngày:</strong> ${invoices[index].date}</p>
                <p><strong>Trạng thái:</strong> <span class="badge ${paymentMethod === "Chưa thanh toán" ? "bg-secondary" : paymentMethod === "Tiền mặt" ? "bg-warning text-dark" : "bg-success"}">${paymentMethod}</span></p>
                <hr>
                <h5>Chi tiết:</h5>
                <ul class="list-group mb-3">
        `;

                invoice.forEach(item => {
                    details += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${item.product}</strong>
                        <div class="text-muted small">${item.quantity} x ${item.price.toLocaleString()} VND</div>
                    </div>
                    <span class="badge bg-primary rounded-pill">${(item.price * item.quantity).toLocaleString()} VND</span>
                </li>
            `;
                });

                details += `
                </ul>
                <div class="d-flex justify-content-between align-items-center border-top pt-3">
                    <h4>Tổng cộng:</h4>
                    <h4 class="text-danger">${total.toLocaleString()} VND</h4>
                </div>
            </div>
        `;

                // Tạo modal thay vì alert
                let modal = document.createElement("div");
                modal.innerHTML = `
            <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Chi tiết hóa đơn</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            ${details}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

                document.body.appendChild(modal);
                var invoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
                invoiceModal.show();

                // Xóa modal sau khi đóng
                document.getElementById('invoiceModal').addEventListener('hidden.bs.modal', function () {
                    modal.remove();
                });
            }
        }

        // Khởi tạo
        document.addEventListener("DOMContentLoaded", loadInvoices);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>